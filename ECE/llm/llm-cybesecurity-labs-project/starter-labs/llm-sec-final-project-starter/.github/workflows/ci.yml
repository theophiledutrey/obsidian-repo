name: ci

on:
  push:
  pull_request:

jobs:
  test-and-eval:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      - name: Set up Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt
          npm i -g promptfoo@latest
      - name: Run promptfoo eval
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
        run: |
          promptfoo eval -c promptfooconfig.yaml -o reports/report.html -o reports/results.json
      - name: Compute metrics
        run: |
          python tools/metrics.py reports/results.json reports/metrics.csv
          cat reports/metrics.csv
      - name: Enforce gates
        run: |
          python - <<'PY'
          import csv, sys
          thr = {"json_rate":0.95, "citation_rate":0.80, "safety_field_rate":0.85}
          vals = {}
          with open('reports/metrics.csv') as f:
            r = csv.reader(f); next(r)
            for k,v in r:
              vals[k]=float(v)
          bad = [k for k,t in thr.items() if vals.get(k,0)<t]
          if bad:
            print("Gates failed:", bad); sys.exit(1)
          print("All gates passed.")
          PY
